# 🔧 Fork 用户自定义指南

本指南专门为 fork 此仓库的用户准备，帮助您启用**从今天 00 点开始显示单日数据**的功能。

## 📋 功能说明

### 默认行为

- **单日数据**：显示最近 24 小时的数据（例如：昨天 15:00 ~ 今天 15:00）
- **数据范围**：滚动的 24 小时窗口

### 自定义功能

- **单日数据**：显示从今天 00:00 开始的数据（例如：今天 00:00 ~ 当前时间）
- **数据范围**：固定从今天凌晨开始

## 🚀 启用步骤

### 第 1 步：修改后端数据获取逻辑

编辑文件：`server/index.js`

找到第 **289-310** 行左右的注释块：

```javascript
/* ====== FORK用户专用功能：从今天00点开始的单日数据 ======
 * 如果您希望单日数据从今天00点开始显示而不是最近24小时，
 * 请取消注释下面的代码块，并注释掉上面的默认代码。
 *
 * 注意：这将改变单日数据的显示方式，从"过去24小时"改为"今天从00:00开始"
 * 同时需要在前端相应地修改数据处理逻辑。
 */
```

**操作步骤：**

1. **注释掉默认代码**（第 285-286 行）：

```javascript
// const hoursSince = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(); // 3天前
// const hoursUntil = new Date().toISOString(); // 现在
```

2. **取消注释自定义代码**（第 295-307 行）：

```javascript
// 获取小时级数据 - 自定义版本：从今天00点开始
const now = new Date();
const todayStart = new Date();
todayStart.setHours(0, 0, 0, 0); // 今天00:00:00

// 为了获取足够的历史数据，仍然获取最近3天
const hoursStartDate = new Date(todayStart);
hoursStartDate.setDate(hoursStartDate.getDate() - 2); // 从3天前开始获取

const hoursSince = hoursStartDate.toISOString();
const hoursUntil = now.toISOString();

console.log(
  `    查询小时级数据时间范围（今天00点模式）: ${hoursSince} 到 ${hoursUntil}`
);
console.log(`    今天开始时间: ${todayStart.toISOString()}`);
```

### 第 2 步：修改前端数据处理逻辑

编辑文件：`web/src/components/Dashboard.jsx`

找到第 **73-99** 行左右的注释块：

```javascript
/* ====== FORK用户专用功能：从今天00点开始的单日数据 ======
 * 如果您在后端启用了从今天00点开始的功能，
 * 请取消注释下面的代码块，并注释掉上面的默认代码。
 *
 * 这将确保单日数据只显示从今天00:00开始的数据。
 */
```

**操作步骤：**

1. **注释掉默认代码**（第 70-71 行）：

```javascript
// const periodHours = selectedPeriod === '1day' ? 24 : 72;
// periodData = sortedData.slice(-Math.min(sortedData.length, periodHours));
```

2. **取消注释自定义代码**（第 79-99 行）：

```javascript
if (selectedPeriod === "1day") {
  // 从今天00点开始的单日数据过滤
  const todayStart = new Date();
  todayStart.setHours(0, 0, 0, 0); // 今天00:00:00

  console.log(`过滤单日数据，从 ${todayStart.toISOString()} 开始`);

  periodData = sortedData.filter((d) => {
    const dataTime = new Date(d.dimensions.datetime);
    return dataTime >= todayStart;
  });

  console.log(`过滤后的单日数据: ${periodData.length} 条记录`);
} else {
  // 3天数据保持原逻辑
  periodData = sortedData.slice(-72);
}
```

## 🔍 验证修改

### 1. 重启服务

```bash
# 后端
cd server
npm start

# 前端
cd web
npm start
```

### 2. 检查控制台输出

打开浏览器开发者工具，查看控制台输出：

**后端日志示例：**

```
查询小时级数据时间范围（今天00点模式）: 2024-01-15T00:00:00.000Z 到 2024-01-17T15:30:00.000Z
今天开始时间: 2024-01-17T00:00:00.000Z
```

**前端日志示例：**

```
过滤单日数据，从 2024-01-17T00:00:00.000Z 开始
过滤后的单日数据: 15 条记录
```

### 3. 验证数据显示

- 切换到"单日数据"选项
- 查看图表的时间轴，应该从今天 00:00 开始
- 数据范围显示应为："今天 00:00 至 当前时间"

## ⚠️ 注意事项

### 1. 时区处理

- 系统使用本地时区计算今天 00:00
- 确保服务器时区设置正确

### 2. 数据可用性

- Cloudflare API 有数据延迟（通常 1-2 小时）
- 今天早期的数据可能需要等待 API 更新

### 3. 缓存影响

- 修改后需要清除浏览器缓存
- 或使用无痕模式验证

### 4. API 限制

- 小时级数据仍然获取最近 3 天，确保数据充足
- 只有前端过滤改变，不影响 API 调用次数

## 🎯 效果对比

### 修改前（默认行为）

```
单日数据范围：2024-01-16 15:00 至 2024-01-17 15:00
显示时间：滚动的24小时窗口
```

### 修改后（自定义功能）

```
单日数据范围：2024-01-17 00:00 至 2024-01-17 15:00
显示时间：今天从00:00开始
```

## 🔄 回滚操作

如需恢复默认行为：

1. **后端**：重新注释自定义代码块，取消注释默认代码
2. **前端**：重新注释自定义代码块，取消注释默认代码
3. **重启服务**

## 📝 技术细节

### 后端改动

- 修改小时级数据查询的时间范围计算
- 保持 3 天查询窗口，确保数据完整性
- 添加调试日志，便于问题排查

### 前端改动

- 单日数据过滤：只显示今天 00:00 之后的数据
- 保持 3 天数据逻辑不变
- 添加过滤日志，便于验证

### 数据流程

1. **后端**：获取最近 3 天小时级数据
2. **前端**：按时间段过滤数据
3. **单日模式**：过滤出今天 00:00 之后的记录
4. **图表显示**：展示过滤后的数据

## 🆘 常见问题

### Q1: 修改后没有数据显示

**A:** 检查当前时间，如果是今天早晨，可能还没有足够的数据。等待几小时后再查看。

### Q2: 时间显示不正确

**A:** 检查服务器时区设置，确保与预期时区一致。

### Q3: 控制台没有看到自定义日志

**A:** 确认代码修改正确，并且重启了服务。

### Q4: 3 天数据显示异常

**A:** 确保只修改了单日数据的处理逻辑，3 天数据逻辑保持不变。

## 📞 支持

如果在使用过程中遇到问题：

1. 检查控制台错误信息
2. 验证代码修改是否正确
3. 确认服务已完全重启
4. 清除浏览器缓存后重试

---

**🎉 享受您的自定义分析仪表盘！**

此功能让您可以更直观地查看今天的数据趋势，特别适合需要按自然日统计的业务场景。
